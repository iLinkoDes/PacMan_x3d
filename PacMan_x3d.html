<!DOCTYPE html>
<!-- ALUMNO: IAN RIVERO CARMONA-->
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pac-Man en X3D</title>
  <script src="https://www.x3dom.org/download/x3dom.js"></script>
  <link rel="stylesheet" href="https://www.x3dom.org/download/x3dom.css">
  <script>
    var originalGetContext = HTMLCanvasElement.prototype.getContext;
    HTMLCanvasElement.prototype.getContext = function(contextType, options) {
      if (contextType === '2d') {
        options = options || {};
        options.willReadFrequently = true;
      }
      return originalGetContext.call(this, contextType, options);
    };
  </script>
  <style>
    body {
      margin: 0;
      background-color: #111;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    #pantallaInicio, #pantallaGameOver, #contenedorJuego, #pantallaGanador {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    #pantallaInicio, #pantallaGameOver, #pantallaGanador {
      background: rgba(0,0,0,0.9);
      text-align: center;
      z-index: 2;
    }
    #pantallaGameOver, #pantallaGanador { display: none; }
    button {
      margin-top: 16px;
      padding: 10px 20px;
      font-size: 1.1em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #1976d2;
      color: white;
    }
    button:hover { background-color: #2196f3; }
    x3d {
      border: 2px solid #444;
      border-radius: 10px;
      background: #000;
    }
   /*  #contenedorJuego { display: flex; } */
  </style>
</head>
<body>

  <div id="pantallaInicio">
    <h1>üöÄ Pac-Man en X3D üöó</h1>
    <p>Usa las flechas ‚Üê ‚Üë ‚Üì ‚Üí para mover a Pac-Man a trav√©s del nivel.<br>
       ¬°Cuidado con los fantasmas! <b>Continuar</b> o <b>Salir</b>.</p>
       <br>Alumno: Ian Rivero Carmona
    <button onclick="iniciarJuego()">Iniciar Juego</button>
  </div>

  <div id="pantallaGameOver">
    <h1>üí• ¬°Game Over!</h1>
    <p>¬øDeseas continuar o salir al men√∫ principal?</p>
    <div>
      <button onclick="reiniciarJuego()">Continuar</button>
      <button onclick="salirJuego()">Salir</button>
    </div>
  </div>
  <div id="pantallaGanador">
    <h1>üéâFelicidades!</h1>
    <p>Ganaste el juego, has recolectado todos los puntos posibles.</p>
    <button onclick="reiniciarJuego()">Reiniciar</button>
    <button onclick="salirJuego()"></button>
  </div>

  <div id="contenedorJuego" style="display:none;">
    <x3d id="escena" width="1200px" height="1200px">
      <scene>
        <background skyColor="0.1 0.1 0.3"></background>
        <Viewpoint position="0 14 0" orientation="1 0 0 -1.57" fieldOfView="1.2" description="Vista superior"></Viewpoint>

        <Transform translation="-7 0.2 -9" rotation="1 0 0 -1.57">
          <Shape>
            <Appearance><Material diffuseColor="1 1 1"></Material></Appearance>
            <Text id="labelPosicion" string='"Jugador: 0, 0"' solid="false">
              <FontStyle family='"SANS"' size="0.5"></FontStyle>
            </Text>
          </Shape>
        </Transform>

        <Transform translation="-3 0.2 -8" rotation="1 0 0 -1.57">
          <Shape>
            <Appearance><Material diffuseColor="1 1 1"></Material></Appearance>
            <Text id="labelObstaculo" string='"Fantasmas"' solid="false">
              <FontStyle family='"SANS"' size="0.5"></FontStyle>
            </Text>
          </Shape>
        </Transform>

        <Shape>
          <Appearance><Material diffuseColor="0.1 0.6 0.1"></Material></Appearance>
          <Box size="11.5 0.1 15.5"></Box>
        </Shape>

        <!-- Jugador (PacMan) -->
        <Transform id="Jugador" translation="0 0.3 0">
          <Shape>
            <Appearance><Material diffuseColor="1 1 0"></Material></Appearance>
            <Box size="0.5 0.5 0.5"></Box>
          </Shape>
        </Transform>

        <!-- Muros del laberinto -->
         <Transform id="MuroSpawn1" translation="0 0 1">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2.5 0.5 0.5"></Box>
            </Shape>
         </Transform>
         <Transform id="MuroSpawn2" translation="-1 0 0">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 1.5"></Box>
            </Shape>
         </Transform>
        <Transform id="MuroSpawn3" translation="1 0 0">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 1.5"></Box>
            </Shape>
         </Transform>
        <Transform id="MuroSpawn4" translation="0.75 0 -1">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 0.5"></Box>
            </Shape>
         </Transform>
        <Transform id="MuroSpawn5" translation="-0.75 0 -1">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 0.5"></Box>
            </Shape>
         </Transform>

         <Transform id="Muro1" translation="-1 0 -2">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro2" translation="1 0 -2">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro3" translation="2 0 -1.25">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro4" translation="2 0 1.25">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

         <Transform id="Muro5" translation="-1 0 2">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro6" translation="1 0 2">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro7" translation="-2 0 -1.25">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro8" translation="-2 0 1.25">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

         <Transform id="Muro9" translation="-1.25 0 -3">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro10" translation="1.25 0 -3">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro11" translation="-1.25 0 3">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro12" translation="1.25 0 3">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro13" translation="-3 0 0">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 6.5"></Box>
            </Shape>
         </Transform>
         
        <Transform id="Muro14" translation="3 0 0">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 6.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro16" translation="-4.25 0 2">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 2.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro18" translation="-4.25 0 -2">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 2.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro15" translation="-3.75 0 0">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro17" translation="3.75 0 0">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro19" translation="4.25 0 2">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 2.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro20" translation="4.25 0 -2">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 2.5"></Box>
            </Shape>
         </Transform>

         <Transform id="Muro21" translation="-2.5 0 -4">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

         <Transform id="Muro22" translation="0 0 -4">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro23" translation="2.5 0 -4">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro24" translation="-4.25 0 -5.25">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 3"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro25" translation="4.25 0 -5.25">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 3"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro26" translation="-3 0 -5.75">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro27" translation="-2 0 -5.75">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro28" translation="-1 0 -5.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro29" translation="0 0 -5.75">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro30" translation="1 0 -5.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro31" translation="3 0 -5.75">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro32" translation="2 0 -5.75">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 2"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro33" translation="-2.5 0 4">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="4.5 0.5 0.5"></Box>
            </Shape>
        </Transform>

        <Transform id="Muro34" translation="2.5 0 4">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="4.5 0.5 0.5"></Box>
            </Shape>
        </Transform>

        <Transform id="Muro35" translation="-3.75 0 5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro36" translation="-4 0 5.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro37" translation="-4.25 0 6">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro38" translation="-4.5 0 6.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro39" translation="-1.25 0 5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro40" translation="-1.25 0 5.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro41" translation="-1.5 0 6">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro42" translation="-1.75 0 6.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="3 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro43" translation="1.25 0 5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro44" translation="1.25 0 5.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro45" translation="1.5 0 6">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro46" translation="1.75 0 6.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="3 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro47" translation="3.75 0 5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="2 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro48" translation="4 0 5.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro49" translation="4.25 0 6">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="1 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro50" translation="4.5 0 6.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro51" translation="-5.5 0 0">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 15.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro52" translation="5.5 0 0">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="0.5 0.5 15.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro53" translation="0 0 -7.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="11.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <Transform id="Muro54" translation="0 0 7.5">
            <Shape>
              <Appearance><Material diffuseColor="0.5 0.5 0.5"></Material></Appearance>
              <Box size="11.5 0.5 0.5"></Box>
            </Shape>
         </Transform>

        <!-- Fantasmas -->
        <Transform id="Obstaculo" translation="0 0.3 0">
          <Shape>
            <Appearance><Material diffuseColor="1 0 0"></Material></Appearance>
            <Box size="0.5 0.5 0.5"></Box>
          </Shape>
        </Transform>
        
        <Transform id="Obstaculo2" translation="0 0.3 0">
          <Shape>
            <Appearance><Material diffuseColor="1 0 1"></Material></Appearance>
            <Box size="0.5 0.5 0.5"></Box>
          </Shape>
        </Transform>
        
        <Transform id="Obstaculo3" translation="0 0.3 0">
          <Shape>
            <Appearance><Material diffuseColor="0 1 1"></Material></Appearance>
            <Box size="0.5 0.5 0.5"></Box>
          </Shape>
        </Transform>

      </scene>
    </x3d>
  </div>

  <script>
    // Tabla de direcciones permitidas seg√∫n el valor de la matriz
    const direccionesPermitidas = {
      0:  { arriba: false, abajo: false, izquierda: false, derecha: false }, // Sin movimiento
      1:  { arriba: true,  abajo: true,  izquierda: true,  derecha: true  },
      2:  { arriba: true,  abajo: true,  izquierda: true,  derecha: false },
      3:  { arriba: true,  abajo: true,  izquierda: false, derecha: true  },
      4:  { arriba: true,  abajo: true,  izquierda: false, derecha: false },
      5:  { arriba: true,  abajo: false, izquierda: true,  derecha: true  },
      6:  { arriba: true,  abajo: false, izquierda: true,  derecha: false },
      7:  { arriba: true,  abajo: false, izquierda: false, derecha: true  },
      8:  { arriba: true,  abajo: false, izquierda: false, derecha: false },
      9:  { arriba: false, abajo: true,  izquierda: true,  derecha: true  },
      10: { arriba: false, abajo: true,  izquierda: true,  derecha: false },
      11: { arriba: false, abajo: true,  izquierda: false, derecha: true  },
      12: { arriba: false, abajo: true,  izquierda: false, derecha: false },
      13: { arriba: false, abajo: false, izquierda: true,  derecha: true  },
      14: { arriba: false, abajo: false, izquierda: true,  derecha: false },
      15: { arriba: false, abajo: false, izquierda: false, derecha: true  }
    };

    let gameActivo = false;
    let animationId = null;

    // Jugador
    let posX = 0, posZ = 0;
    const JUGADOR_Y = 0.3;
    let matrizX = 14, matrizZ = 10;

    // Matriz del laberinto
    const matriz = [ 
        [11,13,13,9,13,9,13,9,13,9,13,9,13,9,13,9,13,9,13,13,10] , 
        [4,0,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,0,4] , 
        [4,0,0,3,13,5,13,2,0,7,13,6,0,3,13,5,13,2,0,0,4] , 
        [4,0,0,4,0,0,0,4,0,0,0,0,0,4,0,0,0,4,0,0,4] , 
        [3,13,13,1,13,9,13,5,13,13,9,13,13,5,13,9,13,1,13,13,2] , 
        [4,0,0,4,0,4,0,0,0,0,4,0,0,0,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,3,13,13,13,13,1,13,13,13,13,2,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,0,0,0,4,0,0,0,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,11,13,13,1,13,13,10,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,4,0,0,4,0,0,4,0,4,0,4,0,0,4] , 
        [3,13,13,6,0,4,0,4,0,11,1,10,0,4,0,4,0,7,13,13,2] , 
        [4,0,0,0,0,3,13,2,0,3,1,2,0,3,13,2,0,0,0,0,4] , 
        [3,13,13,10,0,4,0,4,0,7,5,6,0,4,0,4,0,11,13,13,2] , 
        [4,0,0,4,0,4,0,4,0,0,0,0,0,4,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,7,13,13,9,13,13,6,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,0,0,0,4,0,0,0,0,4,0,4,0,0,4] , 
        [4,0,0,4,0,3,13,13,13,13,1,13,13,13,13,2,0,4,0,0,4] , 
        [4,0,0,4,0,4,0,0,0,0,4,0,0,0,0,4,0,4,0,0,4] , 
        [3,13,13,5,13,5,13,13,13,13,1,13,13,13,13,5,13,5,13,13,2] , 
        [4,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,4] , 
        [3,13,13,13,13,9,13,13,13,13,1,13,13,13,13,9,13,13,13,13,2] , 
        [4,0,0,0,0,4,0,0,0,0,4,0,0,0,0,4,0,0,0,0,4] , 
        [4,0,0,0,11,6,0,0,0,0,4,0,0,0,0,7,10,0,0,0,4] , 
        [4,0,0,11,6,0,0,0,0,0,4,0,0,0,0,0,7,10,0,0,4] , 
        [4,0,11,2,0,0,0,0,0,0,4,0,0,0,0,0,0,3,10,0,4] , 
        [7,13,5,5,13,13,13,13,13,13,5,13,13,13,13,13,13,5,5,13,6] 
    ];


    const spawnPoints = [ 
        [-5,-7], [-3.5,-7], [-2.5,-7], [-1.5, -7], [-0.5, -7], [0.5, -7], [1.5, -7], [2.5, -7], [3.5, -7], [5,-7], 
        [-3.5, -4.5], [-2.5, -4.5], [-1.5, -4.5], [-0.5, -4.5], [0.5, -4.5], [1.5, -4.5], [2.5, -4.5], [3.5, -4.5], 
        [-5,-3.5], [-3.5,-3.5], [-2.5,-3.5], [-1.5, -3.5], [0, -3.5], [1.5, -3.5], [2.5, -3.5], [3.5, -3.5], [5,-3.5], 
        [-2.5, -2.5], [0, -2.5], [2.5, -2.5], 
        [-1.5, -1.5], [0, -1.5], [1.5, -1.5], 
        [-5, -0.5], [-3.5, -0.5], [3.5, -0.5], [5, -0.5], 
        [-2.5, 0], [-1.5, 0], [1.5,0], [2.5, 0], 
        [-5, 0.5], [-3.5, 0.5], [3.5, 0.5], [5, 0.5], 
        [-1.5, 1.5], [0, 1.5], [1.5, 1.5], 
        [-2.5, 2.5], [0, 2.5], [2.5, 2.5], 
        [-5, 3.5], [-3.5, 3.5], [-2.5, 3.5], [0, 3.5], [2.5, 3.5], [3.5, 3.5], [5, 3.5],
        [-5, 4.5], [-2.5, 4.5], [0, 4.5], [2.5, 4.5], [5, 4.5],
        [-5,7], [-3.5,7],  [0.5, 7], [3.5, 7], [5,7]
    ];

    // Configuraci√≥n de fantasmas
    const fantasmas = [
      { 
        id: "Obstaculo", 
        x: 0, z: 0, 
        matrizX: 14, matrizZ: 10,
        speed: 1.5,
        lastMove: 0,
        direccionActual: null
      },
      { 
        id: "Obstaculo2", 
        x: 0, z: 0, 
        matrizX: 14, matrizZ: 10,
        speed: 1.8,
        lastMove: 0,
        direccionActual: null
      },
      { 
        id: "Obstaculo3", 
        x: 0, z: 0, 
        matrizX: 14, matrizZ: 10,
        speed: 2.0,
        lastMove: 0,
        direccionActual: null
      }
    ];

    let lastTs = 0;
    const COL_DIST = 0.4;

    function numerosRandom(range) {
      const count = 3;
      const pool = Array.from({ length: range }, (_, i) => i);
      for (let i = range - 1; i >= range - count; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }
      return pool.slice(range - count);
    }

    function iniciarJuego() {
      document.getElementById("pantallaInicio").style.display = "none";
      document.getElementById("pantallaGameOver").style.display = "none";
      document.getElementById("contenedorJuego").style.display = "flex";
      iniciarEscena();
    }

    function reiniciarJuego() {
      document.getElementById("pantallaGameOver").style.display = "none";
      iniciarEscena();
    }

    function salirJuego() {
      document.getElementById("pantallaGameOver").style.display = "none";
      document.getElementById("contenedorJuego").style.display = "none";
      document.getElementById("pantallaInicio").style.display = "flex";
      detenerAnimacion();
    }

    function iniciarEscena() {
      gameActivo = true;
      posX = 0;
      posZ = 0;
      matrizX = 14;
      matrizZ = 10;
      lastTs = 0;

      const spawns = numerosRandom(66);
      
      // Inicializar fantasmas en posiciones aleatorias
      fantasmas.forEach((fantasma, idx) => {
        const spawn = spawnPoints[spawns[idx]];
        fantasma.x = spawn[0];
        fantasma.z = spawn[1];
        
        // Calcular posici√≥n en matriz desde coordenadas del mundo
        // X mundo: -5 a 5 ‚Üí matrizZ: 0 a 20
        // Z mundo: -7 a 7 ‚Üí matrizX: 0 a 28
        fantasma.matrizZ = Math.round((fantasma.x + 5) / 0.5);
        fantasma.matrizX = Math.round((fantasma.z + 7) / 0.5);
        
        fantasma.lastMove = 0;
        fantasma.direccionActual = null;
        
        document.getElementById(fantasma.id).setAttribute(
          "translation", 
          `${fantasma.x} ${JUGADOR_Y} ${fantasma.z}`
        );
      });

      document.getElementById("Jugador").setAttribute("translation", `${posX} ${JUGADOR_Y} ${posZ}`);
      
      detenerAnimacion();
      animationId = requestAnimationFrame(loop);
    }

    function detenerAnimacion() {
      if (animationId !== null) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    }

    function moverFantasma(fantasma, dt) {
      fantasma.lastMove += dt;
      
      // Cada fantasma se mueve seg√∫n su velocidad
      if (fantasma.lastMove < 1 / fantasma.speed) return;
      
      fantasma.lastMove = 0;
      
      // Verificar que la posici√≥n en matriz sea v√°lida
      /* if (fantasma.matrizX < 0 || fantasma.matrizX >= matriz.length ||
          fantasma.matrizZ < 0 || fantasma.matrizZ >= matriz[0].length) {
        console.log("Fantasma fuera de l√≠mites:", fantasma.id, fantasma.matrizX, fantasma.matrizZ);
        return;
      } */
      
      const valorMatriz = matriz[fantasma.matrizX][fantasma.matrizZ];
      const direcciones = direccionesPermitidas[valorMatriz];
      
      /* if (!direcciones) {
        console.log("Valor de matriz inv√°lido:", valorMatriz);
        return;
      } */
      
      const esBaldosaRestringida = (Math.abs(fantasma.x - 0) < 0.01 && Math.abs(fantasma.z - (-1.5)) < 0.01);

      // Obtener direcciones disponibles
      const posibles = [];
      if (direcciones.arriba) posibles.push('arriba');
      if (direcciones.abajo && !esBaldosaRestringida) posibles.push('abajo');
      if (direcciones.izquierda) posibles.push('izquierda');
      if (direcciones.derecha) posibles.push('derecha');
      
      if (posibles.length === 0) return;
      
      // Eliminar direcci√≥n opuesta a la actual (evitar ir y venir)
      const opuestos = {
        'arriba': 'abajo',
        'abajo': 'arriba',
        'izquierda': 'derecha',
        'derecha': 'izquierda'
      };
      
      let direccionesFinales = posibles;
      if (fantasma.direccionActual && posibles.length > 1) {
        const opuesto = opuestos[fantasma.direccionActual];
        direccionesFinales = posibles.filter(d => d !== opuesto);
        if (direccionesFinales.length === 0) direccionesFinales = posibles;
      }
      
      // Elegir direcci√≥n aleatoria
      const direccion = direccionesFinales[Math.floor(Math.random() * direccionesFinales.length)];
      fantasma.direccionActual = direccion;
      
      // Mover seg√∫n la direcci√≥n
      switch(direccion) {
        case 'arriba':
          fantasma.z -= 0.5;
          fantasma.matrizX -= 1;
          break;
        case 'abajo':
          fantasma.z += 0.5;
          fantasma.matrizX += 1;
          break;
        case 'izquierda':
          fantasma.x -= 0.5;
          fantasma.matrizZ -= 1;
          break;
        case 'derecha':
          fantasma.x += 0.5;
          fantasma.matrizZ += 1;
          break;
      }
      
      // Actualizar posici√≥n visual
      document.getElementById(fantasma.id).setAttribute(
        "translation", 
        `${fantasma.x} ${JUGADOR_Y} ${fantasma.z}`
      );
    }

    function verificarColisiones() {
      for (const fantasma of fantasmas) {
        const dx = Math.abs(posX - fantasma.x);
        const dz = Math.abs(posZ - fantasma.z);
        
        if (dx < COL_DIST && dz < COL_DIST) {
          gameActivo = false;
          detenerAnimacion();
          document.getElementById("pantallaGameOver").style.display = "flex";
          return true;
        }
      }
      return false;
    }

    function loop(ts) {
      if (!gameActivo) return;
      if (!lastTs) lastTs = ts;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;

      // Mover cada fantasma
      fantasmas.forEach(fantasma => moverFantasma(fantasma, dt));
      
      // Verificar colisiones
      if (verificarColisiones()) return;

      animationId = requestAnimationFrame(loop);
    }

    // Movimiento del jugador
    document.addEventListener("keydown", (e) => {
      if (!gameActivo) return;
      
      const valorMatriz = matriz[matrizX][matrizZ];
      const direcciones = direccionesPermitidas[valorMatriz];
      
      if (!direcciones) return;
      
      const jugador = document.getElementById("Jugador");
      
      if (e.key === "ArrowRight" && direcciones.derecha) {
        posX += 0.5;
        matrizZ += 1;
      }
      if (e.key === "ArrowLeft" && direcciones.izquierda) {
        posX -= 0.5;
        matrizZ -= 1;
      } ;
      if (e.key === "ArrowUp" && direcciones.arriba) {
        posZ -= 0.5;
        matrizX -= 1;
      };
      if (e.key === "ArrowDown" && direcciones.abajo) {
        posZ += 0.5;
        matrizX += 1;
      };
      
      jugador.setAttribute("translation", `${posX} ${JUGADOR_Y} ${posZ}`);
      verificarColisiones();
    });

    function actualizarEtiqueta() {
      const textNode = document.querySelector('#labelPosicion');
      if (textNode) {
        textNode.setAttribute(
          'string',
          `"Jugador: X:${posX.toFixed(1)} Z:${posZ.toFixed(1)} Matriz:[${matrizX},${matrizZ}] Valor:${matriz[matrizX][matrizZ]}"`
        );
      };
      
      const textNode2 = document.querySelector('#labelObstaculo');
      if (textNode2) {
        const info = fantasmas.map((f, i) => 
          `F${i+1}:[${f.matrizX},${f.matrizZ}]`
        ).join(' ');
        textNode2.setAttribute('string', `"${info}"`);
      };
    };

    setInterval(actualizarEtiqueta, 100);
    
    // Iniciar autom√°ticamente (comentar esta l√≠nea para mostrar pantalla de inicio)
    //iniciarEscena();
  </script>
</body>
</html>